\chapter{Introduction}

In this paper, we study Algorithm Substitution Attacks (ASAs). ASAs were first presented by Bellare, Paterson, and Rogaway \cite{C:BelPatRog14}, as a specific possibility within the research area of kleptography \cite{C:YouYun96,EC:YouYun97,FSE:YouYun98,SAC:YouYun04,ACISP:YouYun03}. In an ASA on a symmetric encryption scheme, an attacker has the following goal: replace an encryption function with a subverted version, such that, upon observing ciphertexts, the attacker is able to recover the secret key while the user is unable to detect the difference between the subverted and original encryption algorithms \cite{C:BelPatRog14}. Such an attack is certainly outside of the traditional security definitions considered in cryptography. However, revelations of the activities of nation-state intelligence agencies since 2013 \cite{snowden} have shown that such attacks are aligned well with both the intentions and the capabilities of these potential adversaries. Under threat of mass surveillance, it is imperative for us to study the ways in which cryptographic security may be undermined so we can best mitigate the effects.

We contribute two main improvements to the existing literature on ASAs. First, we formalize a possible method for detecting ASAs involving the manipulation of the state maintained by the subverted algorithm. We describe a model that allows a detector to force re-use of the algorithm's maintained state, as could happen when the algorithm is running on a virtual machine. This changes the detectability analysis of several published ASAs, rendering them easily detectable. Second, we describe two modifications to existing ASAs that turn them into asymmetric ASAs, which are more resilient to exploitation by another party who reverse engineers the subverted implementation.

\paragraph{Background.} The possibility of subverting a cryptographic algorithm by changing the implementation to differ from the specification is not new. Termed kleptography, research in this area was initiated by Young and Yung \cite{C:YouYun96}, who did several follow-up works  \cite{EC:YouYun97,FSE:YouYun98,SAC:YouYun04,ACISP:YouYun03}. Their work was inspired by subliminal channels in public-key cryptosystems \cite{EC:Simmons84,C:Desmedt88}, which they then showed could create serious problems. Several authors have studied backdoors in symmetric encryption \cite{FSE:RijPre97,FSE:Paterson99}. Goh, Boneh, Pinkas, and Golle \cite{ISC:GBPG03} studied implementations of TLS/SSL and SSH that provide key recovery capabilities. Schneier, Fredrikson, Kohno, and Ristenpart published a survey of cryptographic subversion in general \cite{EPRINT:SFKR15}.

Crucial in the development of this area of research were the revelations by Edward Snowden of the activities of the NSA in efforts to break the encryption used for internet traffic \cite{snowden}. This included some information on one case of successful cryptographic subversion in practice: the pseudorandom bit generator Dual\_EC\_DRBG \cite{USENIX:CNEGLRBMSF14}. These events renewed interest in this area of research, starting with the work of Bellare, Paterson, and Rogaway \cite{C:BelPatRog14} on ASAs.

\paragraph{Algorithm substitution attacks (ASAs).} Suppose a user $\mathcal{U}$ is using a symmetric encryption scheme $\mathsf{SE}$ for encryption of their communications. An attacker (sometimes referred to as Big Brother) is able to exchange the encryption algorithm $\mathsf{SE.Enc}$ for an alternative algorithm $\mathsf{Sub.Enc}$, which we call the subverted algorithm. While using the algorithm $\mathsf{Sub.Enc}$, $\mathcal{U}$ will send a set of ciphertexts. From observation of these ciphertexts, the attacker wants to be able to recover the secret key $k$ used for encryption. If this was the only requirement, an ASA would be trivial: the subverted encryption algorithm could simply output the secret key on any input. However, the attacker would like continuous exploitation of the system, and so wishes for $\mathcal{U}$ to be unaware of the subversion. For this we require an ASA to be undetectable, meaning that $\mathcal{U}$ should not be able to (with black box access) distinguish between  $\mathsf{Sub.Enc}$ and $\mathsf{SE.Enc}$. A minimum requirement for undetectability would be that all (or all but a negligible fraction) of the possible ciphertexts correctly decrypt, but this alone would not be enough. The formal requirement is captured in a detectability game that the user $\mathcal{U}$ plays.

A variety of techniques can be used to create an ASA, but in general an ASA relies on the attacker sharing a key $\overline{k}$ with the subverted algorithm, and requires that $\mathsf{SE.Enc}$ is randomized. Bellare, Paterson, and Rogaway \cite{C:BelPatRog14}, in their seminal paper, presented a technique involving acceptance-rejection on ciphertexts generated by the unsubverted encryption algorithm. A pseudorandom function is evaluated on $\overline{k}$ and a ciphertext, giving a single bit $b$. If the first bit of secret key is equal to $b$, then that ciphertext is returned; otherwise, a new one is computed. Since the attacker knows $\overline{k}$, he can recover the first bit of the secret key $k$ from the ciphertext. Repeating this for each position within the secret key (which the ASA maintains as state) allows for recovery of the whole key. Since $\overline{k}$ is unknown to $\mathcal{U}$, the ciphertexts still appear randomly generated. Hence both key recovery and undetectability are achieved. \cite{C:BelPatRog14} called this the ``biased-ciphertext attack.''

Degabriele, Farshim, and Poettering \cite{FSE:DegFarPoe15} gave refinements to the definitions of \cite{C:BelPatRog14}. In particular, they relaxed a requirement that all ciphertexts generated by the subverted encryption algorithm must decrypt correctly. They then introduced the notion of an ``input-triggered'' ASA, where a certain input would lead to leaking of the secret key $k$ without regard for correct decryptability. This requires influence over the distribution of encrypted messages in order to enable key recovery. Bellare, Jaeger, and Kane \cite{CCS:BelJaeKan15} improved on the results of \cite{C:BelPatRog14}, notably introducing a stateless version of the biased-ciphertext attack. In this attack, instead of keeping an index as state, it is generated pseudorandomly along with the bit $b$, rendering the ASA stateless.

Aside from symmetric encryption, ASAs on other cryptographic primitives have also been studied. Several authors have published ASAs on signature schemes \cite{CCS:AteMagVen15,BSKC2019,ACISP:LCWW18}. Armour and Poettering explored ASAs on MAC schemes and the decryption side of authenticated encryption \cite{ToSC:ArmPoe19,IMA:ArmPoe19}. Chen, Huang, and Yung presented an ASA against KEMs \cite{AC:CheHuaYun20}. More recently, Berndt et al. studied the implementation of ASAs on the TLS, WireGuard, and Signal protocols \cite{EPRINT:BWPTE20}.

\section{State resets for detection of ASAs}
In the literature, there has been a tendency towards ensuring that new ASAs are stateless. \cite{C:BelPatRog14}, who coined the term ASA, noted that the biased-ciphertext attack they introduced was stateful. They said that, since the attack is stateful, ``a reset of the state will lead to increased detection ability for an observer, but ... this increase does not appear to be enough to lead to actual detection.'' Improving on the results of \cite{C:BelPatRog14}, \cite{CCS:BelJaeKan15} presented their stateless ASA. They seem to interpret some of the conclusions from \cite{C:BelPatRog14} differently, saying, with reference to the previous work, ``a state reset, as can happen with a reboot or cloning to create a virtual machine, leads, in their attack, to detection.'' They then define a notion of undetectability that necessitates statelessness, and call this \emph{strong undetectability}. As a result of the interpretations and emphasis of \cite{CCS:BelJaeKan15}, as well as the fact that stateless subversions have proven more difficult to develop, later work has often acknowledged that stateless schemes are surely preferable. Authors detailing stateful subversions have spent time justifying that the amount of state that they are maintaining is small, and so more palatable for the adversary to include \cite{BSKC2019,AC:CheHuaYun20}.

This begs a question: how does an adversary against the undetectability of a subversion use state resets to detect the subversion? To our knowledge, this question has not been addressed fully in the literature. The closest example is due to Baek, Susilo, Kim, and Chow \cite{BSKC2019}, who included a simple state reset oracle in their undetectability game, which resets the state to the initial null value. However, as noted by \cite{CCS:BelJaeKan15}, we also wish to consider what happens when the algorithm is running on a virtual machine, where the machine state can be cloned and re-run from the same point, potentially many times. The simple state reset oracle is therefore insufficient.

\paragraph{Contributions.}
We present a stronger state reset oracle than that used by \cite{BSKC2019}, which is able to reset the state of the ASA to \emph{any} state previously used in the detection game. Under this new definition, we show that ASAs given by Ateniese, Magri, and Venturi \cite{CCS:AteMagVen15} (on signatures), Baek et al. \cite{BSKC2019} (on DSA signatures), and Chen, Huang, and Yung \cite{AC:CheHuaYun20} (on key exchange) are all easily detectable. On the other hand, we show that original biased-ciphertext ASA by \cite{C:BelPatRog14} is actually just as undetectable as the ``upgraded'', stateless version given by \cite{CCS:BelJaeKan15}. Our analysis of the ASA from \cite{C:BelPatRog14} also uses the same game-playing proof framework as used in \cite{CCS:BelJaeKan15}, avoiding the ``coin-injective'' assumption on the encryption scheme that was necessary in \cite{C:BelPatRog14}. We present these results in \autoref{sec:statereset}.

\section{Asymmetric ASAs}
When introducing ASAs, \cite{C:BelPatRog14} also considered the possibility of an asymmetric ASA on symmetric encryption. An \emph{asymmetric} ASA is one where the subverted algorithm uses an \emph{embedded} key that is different from the \emph{extraction} key used for key recovery; for example, the two keys could be a public-private key pair. The motivation for this comes from noticing that the embedded subversion key is not particularly protected. Instead, it is embedded in, for example, malware, distributed to the target. While we assume in this model that the target themselves will not scrutinize the code they are using, some third party might find out about the subversion, and reverse engineer the software to learn the embedded key. The subverter would have a strong incentive to prevent a third party from obtaining the same key recovery capabilities as the subverter. If the embedded key is presumed to be public knowledge, and the ASA remains undetectable, then the subverter is assured that they are the only one capable of exploiting the ASA. In an appendix, \cite{C:BelPatRog14} give the necessary definitional extensions for asymmetric ASAs, and leave the development of an asymmetric ASA as an open problem. Later works considered asymmetric ASAs in certain specific contexts, like on signature schemes and KEMs that satisfy certain conditions \cite{AC:CheHuaYun20,BSKC2019}.

\paragraph{Contributions.}
In this paper, we will consider two different kinds of asymmetric ASAs. In a \emph{type 1} asymmetric ASA, the subversion is required to be undetectable to an adversary in possession of the embedded subversion key; we call this augmented undetectability. This is the simplest way of thinking about an asymmetric ASA, and the definition that has been used in other literature. In a \emph{type 2} asymmetric ASA, we will instead require that the subversion is only undetectable to an adversary who does not know the embedded subversion key, as in the case of a symmetric ASA, but we also require that a type 2 asymmetric ASA is secure against exploitation (in the sense that the attacker exploits the ASA) by an adversary in possession of the embedded subversion key. This less restrictive requirement is a reflection of the fact that the main goals for an asymmetric ASA (besides recovering the targeted information) are as follows: to ensure that the user of the cryptographic scheme (or some entity with the decision-making authority to halt usage of the cryptographic scheme) being attacked is unaware of the attack, and to ensure that no other entity is able to exploit the ASA to recover the targeted information. While this is accomplished by a type 1 asymmetric ASA (indeed, a type 1 ASA is also a type 2 ASA), our stipulated requirements for a type 2 asymmetric ASA will also suffice. The relaxed requirements allow for more flexibility when designing an ASA, and allows us to create an ASA whose executions take less time.

In \autoref{sec:asymASA}, we modify the ASA of \cite{C:BelPatRog14} to obtain a type 1 asymmetric ASA on symmetric encryption, that is, an ASA undetectable by an adversary who is in possession of the embedded subversion key and is able to use state resets on the encryption scheme. This provides an answer to their open problem explicitly in the case of symmetric encryption. In \autoref{sec:asymASA2} we modify the ASA of \cite{CCS:BelJaeKan15} (which is itself a modification of the ASA from \cite{C:BelPatRog14}) to obtain a type 2 asymmetric ASA on symmetric encryption. To show the advantages of this ASA, we do a thorough analysis of the parameters and techniques the attacker can use in practice to recover the key. We show that our type 2 asymmetric ASA can enable key recovery in practice with a subverted encryption function which runs in less time, making it, in theory, less susceptible to detection by timing.

In order to give a better idea of how these new ASAs compare to other published ASAs, we give a comparison of some basic properties in \autoref{tab:ASAcompare}.

Finally, in \autoref{sec:generalize} we give a generalization of the modifications we made to the above ASAs, in order to apply our results to other cryptographic primitives and security notions. Our results allow for a large class of ASAs to be modified to create type 1 and type 2 asymmetric ASAs. These results apply to any cryptographic primitive, and in the case of the type 2 modification, any game-based notion of security. These results will make it easier for future researchers to evaluate whether their symmetric ASAs can be modified to create asymmetric ASAs.

\begin{table}
\centering
\newcommand{\pie}[1]{%
    \begin{tikzpicture}
    \draw (0,0) circle (3pt);
    \fill (0,3pt) arc[radius = 3pt, start angle= 90, end angle= 90-#1] -- (0,0) -- cycle;
    \end{tikzpicture}%
}
\newcommand{\yes}{{\pie{360}}}
\newcommand{\no}{{\pie{0}}}
\NewDocumentCommand{\rotX}{O{-45} O{1em} m}{\makebox[#2][r]{\rotatebox[origin=r]{#1}{#3}}}%
\vspace{4pt}
\scalebox{0.89}{
\begin{tabular}{p{8cm} cccccc}
\toprule
& \rotX{\cite{C:BelPatRog14}} & \rotX{\cite{CCS:BelJaeKan15}} & \rotX{\cite{BSKC2019}} & \rotX{\cite{AC:CheHuaYun20}} & \rotX{Our type 1} & \rotX{Our type 2} \\
\midrule
Asymmetric 
& \no & \no & \yes & \yes & \yes & \yes \\
\midrule
\multicolumn{7}{l}{\textit{No state reset}} \\
\midrule
Undetectable vs. regular adversary
& \yes & \yes & \yes & \yes & \yes & \yes \\
Undetectable vs. augmented adversary
& \no & \no & \yes & \yes & \yes & \no \\
Secure vs. augmented adversary 
& \no & \no & \yes & \yes & \yes & \yes \\
\midrule
\multicolumn{7}{l}{\textit{State reset}} \\
\midrule
Undetectable vs. regular adversary (SRDET)
& \yes & \yes & \no & \no & \yes & \yes \\
Undetectable vs. augmented adversary (ASRDET)
& \no & \no & \no & \no & \yes & \no \\
Secure vs. augmented adversary 
& \no & \no & \yes & \yes & \yes & \yes \\
\midrule
Intercepted transmissions needed
& $128$ & $\approx 700$ & $3$ & $2$ & $400$ & $\approx 2600$ \\
Runtime multiplier
& $\ge 7$ & $\ge 2$ & $\approx 1$ & $\approx 1$ & $\ge 9$ & $\ge 2$ \\
\bottomrule
\end{tabular}
} %\scalebox
\caption[Comparison of properties of various ASAs]{Comparison of properties of various ASAs. An augmented adversary refers to an adversary in possession of the embedded subversion key. If applicable, $|k|=128$.} \label{tab:ASAcompare}
\end{table}

